<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>檔案管理系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
        }
        #upload-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s, transform 0.2s;
        }
        #upload-button:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }
        #chat-container {
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            padding: 10px;
            background-color: #111;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        #user-input {
            width: 80%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #222;
            color: white;
            margin-right: 10px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }
        #send-button:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }
        #url-response {
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 5px;
            border: 1px solid #555;
            color: white;
            min-height: 50px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        #file-list {
            margin: 50px auto;
            max-width: 600px;
            border: 1px solid #444;
            padding: 20px;
            background-color: #222;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .file-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #333;
            border-radius: 5px;
            border: 1px solid #555;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .file-item:hover {
            transform: translateY(-3px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.7);
        }
        
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <button id="upload-button">上傳</button>
    <div id="chat-container">
        <input type="text" id="user-input" placeholder="輸入youtube url..." />
        <button id="send-button">送出</button>
        <div id="spinner" class="spinner"></div>
        <div id="url-response">等待下載youtube影片...</div>
    </div>
    <div id="file-list">載入檔案中...</div>
    <script>
        const uploadButton = document.getElementById('upload-button');
        const fileListContainer = document.getElementById('file-list');
        const sendButton = document.getElementById('send-button');
        const userInput = document.getElementById('user-input');
        const urlresponse = document.getElementById('url-response');
        const spinner = document.getElementById('spinner');  // 新增 spinner 元素引用

        const apiHost = 'http://192.168.50.11:8000';
        const uploadApi = `${apiHost}/upload`;
        const filelistApi = `${apiHost}/filelist/`;
        const downloadApi = `${apiHost}/download/`;
        const urlApi = `${apiHost}/youtube_download`;

        uploadButton.addEventListener('click', async () => {
            const file = await selectFile();
            if (file) uploadFile(file);
        });

        sendButton.addEventListener('click', () => {
            const message = userInput.value.trim();
            if (message) {
                geturlresponse(message);
                userInput.value = '';
            }
        });

        function selectFile() {
            return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.onchange = () => resolve(input.files[0]);
                input.click();
            });
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            fetch(uploadApi, { method: 'POST', body: formData, headers: { 'accept': 'application/json' } })
                .then(response => response.json())
                .then(() => { alert('上傳成功'); loadFileList(); })
                .catch(() => { alert('上傳失敗'); });
        }

        function loadFileList() {
            fetch(filelistApi)
                .then(response => response.json())
                .then(files => {
                    fileListContainer.innerHTML = '';
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.textContent = file;
                        fileItem.ondblclick = () => downloadFile(file);
                        fileListContainer.appendChild(fileItem);
                    });
                })
                .catch(() => { fileListContainer.innerHTML = '載入結束'; });
        }

        function downloadFile(fileName) {
            window.location.href = `${downloadApi}${fileName}`;
        }

        function geturlresponse(URL) {
            // 按鈕反灰並顯示轉圈
            sendButton.classList.add('disabled');
            sendButton.disabled = true;
            spinner.style.display = 'inline-block';
            urlresponse.textContent = '下載中...';

            fetch(urlApi, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'accept': 'application/json'},
                body: JSON.stringify({url: URL})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // 將響應轉換為 Blob 對象
                return response.blob();
            })
            .then(blob => {
                // 創建一個 URL 對象來指向 Blob 文件
                const downloadUrl = window.URL.createObjectURL(blob);

                // 創建一個隱藏的 <a> 標籤，並設置下載屬性
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.download = 'video.mp4';  // 使用指定的文件名稱

                // 將 <a> 元素添加到 DOM 中並模擬點擊以啟動下載
                document.body.appendChild(downloadLink);
                downloadLink.click();

                // 點擊後移除 <a> 標籤並釋放 URL
                document.body.removeChild(downloadLink);
                window.URL.revokeObjectURL(downloadUrl);

                urlresponse.textContent = '下載完成';
            })
            .catch(error => {
                console.error('下載失敗:', error);
                urlresponse.textContent = `下載失敗: ${error.message}`;
            })
            .finally(() => {
                // 恢復按鈕狀態並隱藏轉圈
                sendButton.classList.remove('disabled');
                sendButton.disabled = false;
                spinner.style.display = 'none';
            });
        }

        setInterval(loadFileList, 5000);
        loadFileList();
    </script>
</body>
</html>
